# Финальная работа
Студент: Веселов Илья

Преподаватель: Моргунов Евгений Павлович

Группа: БПМИ218

Тема: Ресторанный бизнес

### **Введение**  

В современной динамично меняющейся среде ресторанного бизнеса, управление рестораном представляет собой сложную задачу, требующую внимания к множеству аспектов. Основными вызовами являются управление заказами, инвентаризация, взаимодействие с клиентами и эффективное использование рабочей силы. С развитием технологий, возможности автоматизации этих процессов через специализированные базы данных стали крайне актуальными. Такие системы не только способствуют улучшению операционной эффективности, но и обеспечивают значительное улучшение в области клиентского обслуживания.

Управление рестораном включает в себя не только прямое обслуживание клиентов, но и множество закулисных операций, таких как учет запасов, планирование меню, управление персоналом и финансовое планирование. Все эти элементы требуют точного и эффективного подхода к управлению данными. В этом контексте база данных для ресторана выступает как инструмент, позволяющий собирать, анализировать и использовать информацию для оптимизации работы ресторана, а также для предоставления более персонализированных и качественных услуг клиентам.

Создание и внедрение специализированной базы данных позволит ресторану не только упростить многие повседневные операции, но и открыть новые возможности для анализа бизнеса, что, в свою очередь, может привести к более обоснованным управленческим решениям, повышению уровня удовлетворенности клиентов и увеличению прибыли.

### **Основные Аспекты Базы Данных для Ресторана**  
1. **Управление Заказами:** Отслеживание заказов от клиентов, управление статусами заказов, анализ предпочтений клиентов.
2. **Инвентаризация и Управление Запасами:** Автоматизация контроля за запасами ингредиентов, предотвращение дефицита и избытка продуктов.
3. **Клиентская База:** Управление информацией о клиентах, историей их заказов, предпочтениями для персонализированного обслуживания.
4. **Управление Персоналом:** Информация о сотрудниках, расписании смен, оценка эффективности работы.
5. **Финансовый Учет:** Отслеживание доходов и расходов, анализ прибыльности блюд и общей эффективности ресторана.

### **Преимущества Реализации Базы Данных**
- **Повышение Эффективности:** Быстрое и точное управление заказами и запасами.
- **Улучшение Обслуживания:** Персонализированное обслуживание клиентов на основе истории их предпочтений.
- **Оптимизация Ресурсов:** Эффективное распределение рабочего времени персонала и использование продуктов.
- **Принятие Обоснованных Решений:** На основе аналитики данных об операционной деятельности и предпочтениях клиентов.
- **Прозрачность и Контроль:** Централизованный доступ к информации обо всех аспектах работы ресторана.

### **Решаемые Проблемы**
- **Снижение Ошибок в Заказах:** Автоматизация процесса заказа снижает вероятность ошибок.
- **Управление Запасами:** Автоматизированный контроль за запасами помогает предотвратить их излишек или недостаток.
- **Клиентский Сервис:** База данных позволяет обеспечить быстрое и качественное обслуживание, учитывая индивидуальные предпочтения клиентов.
- **Аналитика и Отчетность:** Обеспечивает наличие актуальной информации для принятия управленческих решений.


## **Требования к Данным и Транзакциям для Базы Данных Ресторана**

## **Требования к Данным**

1. **Информация о Клиентах:**
   - Управление данными клиентов: ФИО, контактные данные, предпочтения в меню, история заказов.
   - Интеграция с CRM-системой для персонализации обслуживания и маркетинговых акций.

2. **Управление Заказами:**
   - Детальное отслеживание заказов: время, детали заказа, статус (в обработке, готовится, подан).
   - Связь с системой управления кухней для оптимизации процесса приготовления.

3. **Меню и Блюда:**
   - Каталог блюд с подробным описанием, ценами, фотографиями, информацией о наличии и аллергенах.

4. **Управление Запасами:**
   - Мониторинг и прогнозирование уровней запасов на основе анализа продаж.
   - Управление сроками годности продуктов и предупреждения о необходимости их использования или замены.

5. **Персонал:**
   - Данные о сотрудниках: личная информация, график работы, должность, квалификации, обратная связь от клиентов.
   - Управление сменами, мониторинг рабочих часов, расчет заработной платы.

## **Требования к Транзакциям**

### **Ввод Данных**
1. **Добавление Нового Клиента:**
   - Регистрация данных клиента: ФИО, контактная информация, предпочтения в меню.
   - Внесение истории заказов и особых пожеланий клиентов.

2. **Добавление Нового Заказа:**
   - Ввод информации о заказе, включая выбранные блюда, спецификацию заказа (например, особые пожелания по приготовлению), время заказа и статус (например, в обработке, готовится).

3. **Обновление Меню:**
   - Добавление новых блюд в меню, включая описание, цены, фотографии и информацию о наличии.
   - Ввод информации о сезонных или специальных предложениях.

4. **Управление Запасами:**
   - Ввод данных о новых поставках продуктов, включая количество, срок годности и другую соответствующую информацию.
   - Внесение данных о текущем состоянии запасов и их использовании.

### **Обновление/Удаление Данных**
1. **Изменение Информации о Клиенте:**
   - Обновление контактных данных клиента, изменение предпочтений или истории заказов.
   - Удаление устаревшей или неверной информации о клиентах.

2. **Изменение Заказов:**
   - Внесение изменений в существующие заказы, например, добавление или удаление блюд, изменение времени заказа.
   - Удаление заказов или их частей при отмене заказа клиентом.

3. **Модификация Меню:**
   - Обновление информации о блюдах, изменение цен или описаний.
   - Удаление устаревших или временных предложений из меню.

4. **Управление Запасами:**
   - Обновление информации о запасах, например, при использовании продуктов или их порче.
   - Удаление данных о просроченных или использованных запасах.

### **Запросы к Данным**
1. **Запросы Клиентов:**
   - Выдача информации о статусе и деталях заказа.
   - Предоставление истории заказов и рекомендаций на основе предыдущих предпочтений.

2. **Аналитика Продаж:**
   - Генерация отчетов о популярности блюд, выручке от продаж и загруженности ресторана.
   - Анализ эффективности маркетинговых акций и специальных предложений.

3. **Управление Запасами:**
   - Просмотр текущего состояния запасов, истории их использования и предстоящих поставок.
   - Анализ трендов потребления для оптимизации заказов продуктов.

4. **Отчетность по Персоналу:**
   - Просмотр информации о рабочих часах, эффективности работы персонала и обратной связи от клиентов.
   - Генерация отчетов для расчета заработной платы и анализа производительности персонала.

### **Частые Операции и Распределение Нагрузки**

_Системная Спецификация для Приложения Базы Данных_

**Начальный Размер Базы Данных:**
1. **Персонал:**
   - В сети ресторанов работают около 1000 сотрудников, распределенных по 50 ресторанам.
   - В каждом ресторане в среднем работает около 20 сотрудников, включая поваров, обслуживающий персонал и управляющих.

2. **Клиентская База:**
   - Активная клиентская база насчитывает около 100 000 постоянных клиентов.
   - Регистрируются предпочтения клиентов, история заказов и частота посещений.

3. **Ассортимент Блюд:**
   - В меню каждого ресторана представлено более 100 различных блюд, включая сезонные и специальные предложения.
   - Регулярное обновление меню и добавление новых блюд.

**Темп Роста Базы Данных:**
1. **Новые Клиенты:**
   - Ежемесячно к базе данных добавляется около 1000 новых клиентов.
   - Внедрение программ лояльности для привлечения и удержания клиентов.

2. **Обновление Меню:**
   - Регулярное обновление данных о блюдах, сезонных акциях и специальных предложениях.

3. **Расширение Сети:**
   - Планы на расширение сети ресторанов, включая открытие новых заведений в разных регионах.

### **Типы Информационного Поиска и Их Распределение по Частоте Использования**

1. **Пиковые Часы Активности:**
   - Высокая активность клиентов в период обедов (с 12:00 до 14:00) и ужинов (с 18:00 до 21:00).
   - Увеличенный спрос на онлайн-бронирование и доставку в вечернее время.

2. **Анализ Потребностей Клиентов:**
   - Интенсивный анализ данных о предпочтениях клиентов для формирования маркетинговых акций и специальных предложений.

3. **Управление Запасами:**
   - Регулярный запрос данных о запасах продуктов для обеспечения своевременного пополнения и минимизации отходов.

### **Требования к Работе в Сети и Совместному Доступу**
1. **Единая База Данных:**
   - Централизованная система для синхронизации данных между всеми ресторанами сети.
   - Обеспечение доступа к обновленной информации о меню, запасах и клиентах в реальном времени.

2. **Быстродействие Операций:**
   - Мгновенная обработка онлайн-заказов и бронирований.
   - Быстрая выгрузка данных для аналитических отчетов и управленческих решений.

3. **Совместный Доступ:**
   - Многопользовательский доступ с разграничением прав на пр

осмотр и редактирование данных в зависимости от роли сотрудника.

### **Защита и Конфиденциальность Данных**
1. **Безопасность Данных:**
   - Применение современных технологий шифрования и защиты для обеспечения конфиденциальности клиентских данных.
   - Регулярное обновление систем безопасности для предотвращения несанкционированного доступа.

### **Копирование и Восстановление, Юридические Вопросы**
1. **Резервное Копирование:**
   - Автоматизированное резервное копирование данных для предотвращения потери информации в случае сбоев или аварий.
   - Разработка плана восстановления данных после потенциальных сбоев системы.

2. **Соответствие Законодательству:**
   - Соблюдение нормативных требований в области обработки и хранения персональных данных клиентов.
   - Проведение регулярных юридических аудитов для проверки соответствия действующему законодательству.
  
## Концептуальная модель ##
На основе описанния предметной области и прецедентов формируется первоначальная концептуальная модель предметной области:

<center>
<img src="./img/concept_model.png " />
<p>Концептуальная модель БД</p>
</center>

## Логическая модель ##
<center>
<img src="./img/log_model.png " />
<p>Логическая модель БД</p>
</center>

**Первичные ключи (PK)**: Уникальные идентификаторы для каждой таблицы, как указано выше.

**Внешние ключи (FK)**: Обеспечивают связи между таблицами. Например, `SupplierID` в таблице `Ingredients` ссылается на `Suppliers`.

**Нормализация**: Отношения `Orders` и `Dishes` декомпозированы для предотвращения избыточности данных и соответствия 3NF.


## Физическая модель ##

<center>
<img src="./img/fith_model.png " />
<p>Физическая модель БД</p>
</center>

Дополнительные связи:
- Если предполагается, что блюдо может содержать несколько ингредиентов, и ингредиенты могут использоваться в нескольких блюдах, добавили таблицу `DishIngredients`.

Это позволит отслеживать, какие ингредиенты используются в каких блюдах. Стрелки от `DishID` и `IngredientID` будут указывать на `DishIngredients.DishID` и `DishIngredients.IngredientID` соответственно. Такая модель позволяет отслеживать связи между таблицами и обеспечивает надлежащую нормализацию базы данных.

Все таблицы находятся в 3НФ. Так как:
1. Ни один неключевой атрибут таблицы не находится в транзитивной функциональной зависимости от потенциального ключа 
2. Каждый неключевой атрибут неприводимо зависит от (каждого) потенциального ключа таблицы
3. Все  атрибуты таблиц атомарны (их нельзя разделить на более простые)

## Реализация ##
**Requiremnts**
- Docker
- Docker-compose

**Запуск сервера БД**

```bash 
$ docker-compose up -d 
```
**Подключение к серверу**
```bash 
$ docker exec -it final-server /usr/bin/psql -U root -d final
```

### Таблицы ###

```sql
-- Создание таблицы ресторанов
CREATE TABLE Restaurants (
    RestaurantID SERIAL PRIMARY KEY,             -- Уникальный идентификатор ресторана
    Name VARCHAR(255) NOT NULL,                  -- Название ресторана
    Address TEXT NOT NULL,                       -- Адрес ресторана
    Phone VARCHAR(50),                           -- Контактный телефон ресторана
    OperatingHours VARCHAR(255)                  -- Режим работы ресторана
);

-- Создание таблицы поставщиков
CREATE TABLE Suppliers (
    SupplierID SERIAL PRIMARY KEY,               -- Уникальный идентификатор поставщика
    Name VARCHAR(255) NOT NULL,                  -- Название компании-поставщика
    Phone VARCHAR(50),                           -- Контактный телефон поставщика
    TypeOfGoods VARCHAR(255),                    -- Тип поставляемых товаров
    ContactPerson VARCHAR(255)                   -- Контактное лицо поставщика
);

-- Создание таблицы ингредиентов
CREATE TABLE Ingredients (
    IngredientID SERIAL PRIMARY KEY,             -- Уникальный идентификатор ингредиента
    Name VARCHAR(255) NOT NULL,                  -- Название ингредиента
    Cost DECIMAL(10, 2) NOT NULL,                -- Стоимость ингредиента
    ExpirationDate DATE NOT NULL,                -- Срок годности ингредиента
    SupplierID INT REFERENCES Suppliers(SupplierID) -- Ссылка на поставщика
);

-- Создание таблицы блюд
CREATE TABLE Dishes (
    DishID SERIAL PRIMARY KEY,                   -- Уникальный идентификатор блюда
    Name VARCHAR(255) NOT NULL,                  -- Название блюда
    Description TEXT,                            -- Описание блюда
    Price DECIMAL(10, 2) NOT NULL,               -- Цена блюда
    Category VARCHAR(255)                        -- Категория блюда (например, основное блюдо, закуска)
);

-- Создание таблицы заказов
CREATE TABLE Orders (
    OrderID SERIAL PRIMARY KEY,                  -- Уникальный идентификатор заказа
    OrderDate TIMESTAMP NOT NULL,                -- Дата и время создания заказа
    TableNumber INT,                             -- Номер стола
    TotalAmount DECIMAL(10, 2) NOT NULL,         -- Общая сумма заказа
    Status VARCHAR(50),                          -- Статус заказа (например, ожидается, готов)
    ClientID INT REFERENCES Clients(ClientID)    -- Ссылка на клиента
);

-- Создание таблицы клиентов
CREATE TABLE Clients (
    ClientID SERIAL PRIMARY KEY,                 -- Уникальный идентификатор клиента
    FullName VARCHAR(255) NOT NULL,              -- Полное имя клиента
    Phone VARCHAR(50),                           -- Контактный телефон клиента
    FoodPreferences TEXT                         -- Предпочтения клиента в еде
);

-- Создание таблицы отзывов
CREATE TABLE Reviews (
    ReviewID SERIAL PRIMARY KEY,                 -- Уникальный идентификатор отзыва
    Text TEXT NOT NULL,                          -- Текст отзыва
    Rating INT,                                  -- Оценка отзыва
    ReviewDate TIMESTAMP NOT NULL,               -- Дата и время создания отзыва
    ClientID INT REFERENCES Clients(ClientID)    -- Ссылка на клиента
);

-- Создание таблицы сотрудников
CREATE TABLE Employees (
    EmployeeID SERIAL PRIMARY KEY,               -- Уникальный идентификатор сотрудника
    FullName VARCHAR(255) NOT NULL,              -- Полное имя сотрудника
    Position VARCHAR(255),                       -- Должность сотрудника
    Salary DECIMAL(10, 2),                       -- Зарплата сотрудника
    StartDate DATE,                              -- Дата начала работы сотрудника
    RestaurantID INT REFERENCES Restaurants(RestaurantID) -- Ссылка на ресторан
);

-- Таблица связи многие-ко-многим для блюд и ингредиентов
CREATE TABLE DishIngredients (
    DishID INT REFERENCES Dishes(DishID),       -- Ссылка на блюдо
    IngredientID INT REFERENCES Ingredients(IngredientID), -- Ссылка на ингредиент
    PRIMARY KEY (DishID, IngredientID)          -- Композитный первичный ключ
);

-- Таблица для детализации заказа
CREATE TABLE OrderDetails (
    OrderDetailID SERIAL PRIMARY KEY,            -- Уникальный идентификатор детали заказа
    OrderID INT REFERENCES Orders(OrderID),      -- Ссылка на заказ
    DishID INT REFERENCES Dishes(DishID),        -- Ссылка на блюдо
    Quantity INT                                  -- Количество заказанного блюда
);
```

## Данные для базы данных ##
Набор SQL-запросов для вставки данных в каждую из таблиц:

```sql
-- Вставка данных в таблицу Restaurants
INSERT INTO Restaurants (Name, Address, Phone, OperatingHours) VALUES
('Оазис', 'Улица Пушкина, 10', '123-456-7890', '10:00 - 22:00'),
('Бистро', 'Проезд Лермонтова, 15', '123-456-7891', '09:00 - 20:00');

-- Вставка данных в таблицу Suppliers
INSERT INTO Suppliers (Name, Phone, TypeOfGoods, ContactPerson) VALUES
('Овощи Круглый Год', '123-456-7892', 'Овощи', 'Иван Иванов'),
('Мясо Делюкс', '123-456-7893', 'Мясо', 'Петр Петров');

-- Вставка данных в таблицу Ingredients
INSERT INTO Ingredients (Name, Cost, ExpirationDate, SupplierID) VALUES
('Томаты', 30.50, '2023-12-31', 1),
('Говядина', 300.00, '2023-12-31', 2);

-- Вставка данных в таблицу Dishes
INSERT INTO Dishes (Name, Description, Price, Category) VALUES
('Цезарь', 'Классический салат Цезарь', 150.00, 'Салаты'),
('Стейк', 'Стейк из мраморной говядины', 350.00, 'Основные блюда');

-- Вставка данных в таблицу Orders
INSERT INTO Orders (OrderDate, TableNumber, TotalAmount, Status, ClientID) VALUES
('2023-12-01 19:00:00', 5, 500.00, 'В обработке', 1);

-- Вставка данных в таблицу Clients
INSERT INTO Clients (FullName, Phone, FoodPreferences) VALUES
('Василий Пупкин', '123-456-7894', 'Любит мясо');

-- Вставка данных в таблицу Reviews
INSERT INTO Reviews (Text, Rating, ReviewDate, ClientID) VALUES
('Отличный ресторан, все понравилось', 5, '2023-12-01 20:00:00', 1);

-- Вставка данных в таблицу Employees
INSERT INTO Employees (FullName, Position, Salary, StartDate, RestaurantID) VALUES
('Анна Смирнова', 'Официант', 25000.00, '2023-01-01', 1);

-- Вставка данных в таблицу DishIngredients
INSERT INTO DishIngredients (DishID, IngredientID) VALUES
(1, 1),
(2, 2);

-- Вставка данных в таблицу OrderDetails
INSERT INTO OrderDetails (OrderID, DishID, Quantity) VALUES
(1, 1, 2),
(1, 2, 1);
```

### Обеспечение целостности через триггерные функции ###

### Создание триггеров и хранимых процедур ###

**Триггер для автоматической проверки срока годности ингредиентов при вставке или обновлении:**
```sql
CREATE OR REPLACE FUNCTION check_expiration_date()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.ExpirationDate < CURRENT_DATE THEN
        RAISE EXCEPTION 'Срок годности ингредиента истёк: %', NEW.Name;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER check_ingredient_expiration
BEFORE INSERT OR UPDATE ON Ingredients
FOR EACH ROW EXECUTE FUNCTION check_expiration_date();
```

**Триггер для обновления суммы заказа в таблице заказов при добавлении или изменении деталей заказа:**
```sql
CREATE OR REPLACE FUNCTION update_total_amount()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE Orders
    SET TotalAmount = TotalAmount + (SELECT Price FROM Dishes WHERE DishID = NEW.DishID) * NEW.Quantity
    WHERE OrderID = NEW.OrderID;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_order_amount
AFTER INSERT OR UPDATE ON OrderDetails
FOR EACH ROW EXECUTE FUNCTION update_total_amount();
```

### Создание хранимых процедур ###

**Хранимая процедура для получения полной информации о блюде по его ID:**
```sql
CREATE OR REPLACE FUNCTION get_dish_info(dish_id INT)
RETURNS TABLE (
    DishName VARCHAR,
    DishDescription TEXT,
    DishPrice DECIMAL,
    CategoryName VARCHAR
) AS $$
BEGIN
    RETURN QUERY
    SELECT d.Name, d.Description, d.Price, c.Category
    FROM Dishes d
    JOIN Categories c ON d.Category = c.CategoryID
    WHERE d.DishID = dish_id;
END;
$$ LANGUAGE plpgsql;
```

**Хранимая процедура для добавления нового клиента:**
```sql
CREATE OR REPLACE FUNCTION add_new_client(fullname VARCHAR, phone VARCHAR, preferences TEXT)
RETURNS VOID AS $$
BEGIN
    INSERT INTO Clients (FullName, Phone, FoodPreferences) VALUES (fullname, phone, preferences);
END;
$$ LANGUAGE plpgsql;
```

### Ввод данных и выполнение запросов ###

**Пример запроса с CTE и оконной функцией:**
```sql
WITH RankedDishes AS (
    SELECT *,
    RANK() OVER(PARTITION BY Category ORDER BY Price DESC) as PriceRank
    FROM Dishes
)
SELECT DishID, Name, Description, Price, PriceRank
FROM RankedDishes
WHERE PriceRank <= 3;
```

Этот запрос выдаст три самых дорогих блюда в каждой категории.

<center>
<img src="./img/example_1.png " />
</center>

**Запрос с подзапросом для получения средней цены блюд в каждой категории:**
```sql
SELECT 
  Category, 
  (SELECT AVG(Price) FROM Dishes WHERE Category = d.Category) AS AvgPrice
FROM 
  Dishes d
GROUP BY 
  Category;
```

<center>
<img src="./img/example_2.png " />
</center>

**Запрос с CTE для подсчёта количества блюд в каждой категории:**
```sql
WITH CategoryCounts AS (
  SELECT 
    Category, 
    COUNT(*) AS DishCount
  FROM 
    Dishes
  GROUP BY 
    Category
)
SELECT 
  Category, 
  DishCount 
FROM 
  CategoryCounts
ORDER BY 
  DishCount DESC;
```

<center>
<img src="./img/example_3.png " />
</center>

**Запрос с оконной функцией для определения ранга блюд по цене внутри каждой категории:**
```sql
SELECT 
  DishID, 
  Name, 
  Price, 
  Category,
  RANK() OVER (PARTITION BY Category ORDER BY Price DESC) AS PriceRank
FROM 
  Dishes;
```

<center>
<img src="./img/example_4.png " />
</center>

## Заключение ##

В ходе выполнения запросов была смоделирована работа базы данных для ресторана. Были созданы таблицы для хранения информации о ресторанах, поставщиках, ингредиентах, блюдах, заказах, клиентах, отзывах и сотрудниках. Вставка данных демонстрирует, как могут быть добавлены записи в каждую из таблиц. Мы также рассмотрели выполнение запросов с использованием подзапросов, общих табличных выражений (CTE) и оконных функций для демонстрации работы с данными. Эти запросы помогают в анализе и предоставлении отчётов, что является ключевым аспектом управления рестораном и обеспечения высокого уровня обслуживания клиентов.

Для поддержания актуальности и целостности данных в базе были реализованы различные ограничения и триггеры. Это позволяет автоматизировать процессы проверки и обновления информации в базе, уменьшая вероятность ошибок и обеспечивая высокую надёжность данных.

## Прочее ##

**Очистка всех таблиц:**

```sql
TRUNCATE TABLE Restaurants, Suppliers, Ingredients, Dishes, Orders, Clients, Reviews, Employees, DishIngredients, OrderDetails RESTART IDENTITY CASCADE;
```

Это удалит все данные из указанных таблиц и сбросит автоинкрементные значения (`SERIAL`). Опция `CASCADE` также удаляет данные из всех связанных таблиц.

амп базы данных находиться в файле [sqldump/final.dump.sql](https://github.com/ilyhav/sql_final_work/blob/main/my_database_dump.sql)
